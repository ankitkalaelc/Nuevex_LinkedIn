<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>NUEVEX Cognitive Evaluation v3</title>

  <style>
    :root { 
      --bg:#0b0f14; --card:#111826; --text:#e6eefc; 
      --muted:#a7b1c2; --accent:#4ea8ff; --bad:#ff6b6b; --good:#4eff8c;
      --outline:#223249;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);
      font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif}

    .app{display:grid;min-height:100%;grid-template-rows:auto 1fr auto;}
    header{position:sticky;top:0;z-index:10;
      background:linear-gradient(180deg, rgba(11,15,20,.95), rgba(11,15,20,.7));
      backdrop-filter:saturate(160%) blur(6px);
      border-bottom:1px solid #1d2a3b}
    .bar{max-width:820px;margin:0 auto;padding:12px 16px;display:flex;align-items:center;gap:12px}
    .brand{display:flex;align-items:center;gap:10px}
    .brand .logo{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,#4ea8ff,#7c5cff)}
    .brand h1{font-size:16px;margin:0;font-weight:700;letter-spacing:.2px}
    .progress-wrap{flex:1;margin-left:20px}
    .progress-bar{width:100%;background:#1d2a3b;border-radius:8px;height:10px;overflow:hidden}
    .progress-fill{height:100%;background:linear-gradient(90deg,#4ea8ff,#7c5cff);width:0;transition:width .3s ease}
    .progress-text{font-size:12px;color:var(--muted);margin-top:2px;text-align:right}

    main{display:grid;place-items:start;}
    .card{max-width:820px;width:100%;margin:18px auto;padding:22px;border:1px solid #1d2a3b;background:var(--card);
      border-radius:20px;box-shadow:0 8px 28px rgba(0,0,0,.25);animation:fadeIn .35s ease}

    .title{font-size:18px;margin:0 0 8px}
    .desc{color:var(--muted);margin:0 0 16px}
    .actions{display:flex;flex-wrap:wrap;gap:12px;margin-top:16px}
    button{appearance:none;border:0;border-radius:14px;padding:14px 18px;font-weight:700;cursor:pointer;
      background:var(--accent);color:#001227;box-shadow:0 4px 14px rgba(78,168,255,.35);transition:all .2s ease}
    button:hover:not([disabled]){transform:translateY(-1px)}
    button[disabled]{opacity:.5;cursor:not-allowed}
    .btn-secondary{background:#1d2a3b;color:var(--text);box-shadow:none;border:1px solid var(--outline)}
    .options{display:grid;gap:10px}
    .opt{display:flex;align-items:center;gap:10px;padding:12px;border:1px solid var(--outline);background:#0f1521;border-radius:12px}
    .opt input{width:22px;height:22px}
    label{cursor:pointer}

    .textarea{width:100%;min-height:120px;padding:12px 14px;border-radius:12px;border:1px solid var(--outline);background:#0f1521;color:var(--text)}
    .textarea:focus{outline:2px solid var(--accent)}
    .input{width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--outline);background:#0f1521;color:var(--text)}
    .input:focus{outline:2px solid var(--accent)}

    .char-counter{font-size:13px;margin-top:4px;color:var(--muted)}
    .char-counter.valid{color:var(--good)}
    .char-counter.error{color:var(--bad)}
    .error{color:var(--bad);margin-top:8px;min-height:18px}
    footer{max-width:820px;margin:0 auto 20px;padding:0 16px}
    .dbg{margin-top:10px;color:#ffe380;font-size:12px}
    @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
  </style>
</head>

<body>
<div class="app">
<header>
  <div class="bar">
    <div class="brand">
      <div class="logo"></div>
      <h1>Elicit Research: NUEVEX Cognition</h1>
    </div>
    <div class="progress-wrap">
      <div class="progress-bar"><div id="progressFill" class="progress-fill"></div></div>
      <div id="progressText" class="progress-text">0% complete</div>
    </div>
  </div>
</header>

<main>
  <section id="screen" class="card"></section>
</main>

<footer>
  <div class="actions">
    <button id="nextBtn">Next</button>
  </div>
  <div id="debug" class="dbg"></div>
</footer>
</div>

<script>
window.addEventListener('DOMContentLoaded', function(){

const REDIRECT_BASE = "https://api.opnion.io/processfinish";
const NEUVEX_SHARED_KEY = "opnionnuevex";

const ENDPOINTS = [
  "https://hook.us1.make.com/bv9ku0rgbu4nc1labsafcbqs0cs74rky",
  "https://script.google.com/macros/s/AKfycbyAeO8NlIS-uSOy2uJIRuF3cYfZm1FaLOLHOXe_yu5Ry2_YP0yXpqCSoUFvXYZFIW2yWg/exec"
];

const qs = new URLSearchParams(location.search);
const PID = (qs.get('pid') || '').trim();
if(!PID){
  document.getElementById('screen').innerHTML = "<h2>Missing PID</h2>";
  return;
}

const STORAGE_KEY = 'neuvex_v3:' + PID;
let S = JSON.parse(localStorage.getItem(STORAGE_KEY) || 'null') || {
  version:'3.0.0',
  pid:PID,
  started_at:Date.now(),
  step:0,
  answers:{},
  qTimes:{},
  typing:{},
  outcome:null
};

const Q = [
  {id:'q4_zip', type:'postal', title:'What is your ZIP / Postal Code?'}
];

const screen = document.getElementById('screen');
const nextBtn = document.getElementById('nextBtn');

render();

function render(){
  const q = Q[S.step];
  screen.innerHTML =
    '<h2 class="title">'+q.title+'</h2>' +
    '<input id="'+q.id+'" class="input" autocomplete="postal-code" inputmode="text" maxlength="10" placeholder="e.g., SW1A 1AA / M5V 3L9 / 110001" />' +
    '<div id="err" class="error"></div>';
}

nextBtn.onclick = function(){
  const q = Q[S.step];
  const val = document.getElementById(q.id).value.trim().toUpperCase().replace(/\s+/g,' ');
  
  if(!/^[A-Z0-9 -]+$/.test(val)){
    return showError("Please enter a valid ZIP / Postal Code.");
  }

  const compact = val.replace(/[\s-]/g,'');
  if(compact.length < 3 || compact.length > 10){
    return showError("Please enter a valid ZIP / Postal Code.");
  }

  S.answers[q.id] = val;
  S.qTimes[q.id] = Date.now() - S.started_at;

  exitWithOutcome('complete','zip_test');
};

function showError(msg){
  document.getElementById('err').textContent = msg;
}

function exitWithOutcome(type, reason){
  S.outcome = type;
  const endAt = Date.now();

  const payload = {
    x_key: NEUVEX_SHARED_KEY,
    pid:S.pid,
    outcome:type,
    reason:reason,
    total_time_sec:Math.round((endAt - S.started_at)/1000),
    answers:S.answers,
    q_times_ms:S.qTimes
  };

  ENDPOINTS.forEach(url=>{
    navigator.sendBeacon(url,new Blob([JSON.stringify(payload)],{type:'application/json'}));
  });

  setTimeout(()=>{
    location.href = REDIRECT_BASE + "?status=1&transactionid="+encodeURIComponent(PID);
  },600);
}

});
</script>
</body>
</html>
