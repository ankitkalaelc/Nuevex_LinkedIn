<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Neuvex v3 ‚Äî Cognitive Evaluation</title>
  <!--
    Redirects:
      Success                -> https://api.opnion.io/processfinish?status=1&transactionid={PID}
      Termination (DQ)       -> https://api.opnion.io/processfinish?status=2&transactionid={PID}
      Over Quota             -> https://api.opnion.io/processfinish?status=3&transactionid={PID}
      Quality Termination    -> https://api.opnion.io/processfinish?status=4&transactionid={PID}

    Data sinks (Make first, GAS second):
      - Make: https://hook.us1.make.com/bv9ku0rgbu4nc1labsafcbqs0cs74rky
      - GAS : https://script.google.com/macros/s/AKfycbyAeO8NlIS-uSOy2uJIRuF3cYfZm1FaLOLHOXe_yu5Ry2_YP0yXpqCSoUFvXYZFIW2yWg/exec
  -->
  <style>
    :root { --bg:#0b0f14; --card:#111826; --text:#e6eefc; --muted:#a7b1c2; --accent:#4ea8ff; --bad:#ff6b6b; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif}
    .app{display:grid;min-height:100%;grid-template-rows:auto 1fr auto;}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg, rgba(11,15,20,.95), rgba(11,15,20,.7));backdrop-filter:saturate(160%) blur(6px);border-bottom:1px solid #1d2a3b}
    .bar{max-width:720px;margin:0 auto;padding:12px 16px;display:flex;align-items:center;gap:12px}
    .brand{display:flex;align-items:center;gap:10px}
    .brand .logo{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,#4ea8ff,#7c5cff)}
    .brand h1{font-size:16px;margin:0;font-weight:700;letter-spacing:.2px}
    .progress{margin-left:auto;font-weight:600;letter-spacing:.2px}
    main{display:grid;place-items:start;}
    .card{max-width:720px;width:100%;margin:18px auto;padding:18px;border:1px solid #1d2a3b;background:var(--card);border-radius:18px;box-shadow:0 8px 28px rgba(0,0,0,.25)}
    .title{font-size:18px;margin:0 0 8px}
    .desc{color:var(--muted);margin:0 0 16px}
    .actions{display:flex;flex-wrap:wrap;gap:12px;margin-top:16px}
    button{appearance:none;border:0;border-radius:14px;padding:14px 18px;font-weight:700;cursor:pointer;background:var(--accent);color:#001227;box-shadow:0 4px 14px rgba(78,168,255,.35)}
    button[disabled]{opacity:.5;cursor:not-allowed}
    .btn-secondary{background:#1d2a3b;color:var(--text);box-shadow:none;border:1px solid #223249}
    .options{display:grid;gap:10px}
    .opt{display:flex;align-items:center;gap:10px;padding:12px;border:1px solid #223249;background:#0f1521;border-radius:12px}
    .opt input{width:22px;height:22px}
    label{cursor:pointer}
    .textarea{width:100%;min-height:120px;padding:12px 14px;border-radius:12px;border:1px solid #223249;background:#0f1521;color:var(--text);font:inherit}
    .input{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #223249;background:#0f1521;color:var(--text);font:inherit}
    .error{color:var(--bad);margin-top:8px}
    .hint{color:var(--muted);font-size:14px}
    .sr-only{position:absolute !important;left:-9999px !important;top:auto !important;width:1px !important;height:1px !important;overflow:hidden !important}
    .skip{position:absolute;left:-999px;top:auto;width:1px;height:1px;overflow:hidden}
    .skip:focus{left:16px;top:10px;width:auto;height:auto;background:#000;color:#fff;padding:8px 12px;border-radius:8px;z-index:9999}
    footer{max-width:720px;margin:0 auto 20px;padding:0 16px}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;background:#0e1a2a;border:1px solid #1f2e45;border-radius:6px;padding:2px 6px}
    .dbg{margin-top:10px;color:#ffe380;font-size:12px}
  </style>
</head>
<body>
  <a href="#main" class="skip">Skip to content</a>
  <div class="app" role="application" aria-label="Neuvex Cognitive Survey v3">
    <header>
      <div class="bar" role="banner">
        <div class="brand" aria-label="Elicit Neuvex">
          <div class="logo" aria-hidden="true"></div>
          <h1>Neuvex Cognitive Evaluation</h1>
        </div>
        <div id="progress" class="progress" aria-live="polite">‚Äî</div>
      </div>
    </header>

    <main id="main">
      <section id="screen" class="card" role="group" aria-describedby="progress"></section>
    </main>

    <footer>
      <div class="actions">
        <button id="prevBtn" class="btn-secondary" aria-label="Previous question" hidden>Back</button>
        <button id="nextBtn" aria-label="Next question">Next</button>
      </div>
      <div id="debug" class="dbg"></div>
    </footer>
  </div>

  <script>
  // Show any JS error to the respondent
  window.addEventListener('error', function(ev){
    try{
      var scr = document.getElementById('screen');
      if(scr){
        scr.innerHTML = '<h2 class="title">Script error</h2><p class="desc">'+escapeHTML(ev.message || 'Unknown error')+'</p>';
      }
    }catch(e){}
  });

  window.addEventListener('DOMContentLoaded', function(){
    (function(){
      const qs = new URLSearchParams(location.search);
      const DEBUG = qs.get('debug') === '1';

      // ===== CONFIG =====
      const REDIRECT_BASE = "https://api.opnion.io/processfinish";
      const NEUVEX_SHARED_KEY = "opnionnuevex"; // rotate periodically

      // Make first (authoritative); GAS second (durable backstop)
      const ENDPOINTS = [
        "https://hook.us1.make.com/bv9ku0rgbu4nc1labsafcbqs0cs74rky",
        "https://script.google.com/macros/s/AKfycbyAeO8NlIS-uSOy2uJIRuF3cYfZm1FaLOLHOXe_yu5Ry2_YP0yXpqCSoUFvXYZFIW2yWg/exec"
      ].filter(Boolean);

      // ===== PID REQUIRED =====
      const PID = (
        qs.get('pid') || qs.get('PID') || qs.get('transactionid') || qs.get('txid') || ''
      ).trim();

      const screenEl = document.getElementById('screen');
      const progressEl = document.getElementById('progress');
      const nextBtn = document.getElementById('nextBtn');
      const prevBtn = document.getElementById('prevBtn');
      const dbg = document.getElementById('debug');

      if (!PID) {
        screenEl.innerHTML = '<h2 class="title">Missing Participant ID</h2><p class="desc">This survey link must include a PID. Example:<br><span class="kbd">?pid=ELR12345</span></p>';
        nextBtn.hidden = true; prevBtn.hidden = true;
        if(DEBUG){ dbg.textContent = 'DEBUG: PID missing. URL=' + location.href; }
        return;
      }
      if(DEBUG){ dbg.textContent = 'DEBUG: PID=' + PID; }

      // ===== STORAGE =====
      const STORAGE_KEY = 'neuvex_v3:' + PID;

      // ===== STATE =====
      const defaultState = {
        version: '3.0.0',
        pid: PID,
        started_at: Date.now(),
        resumed: false,
        step: 'consent', // 'q', 'done'
        qIndex: 0,
        answers: {},
        qTimes: {},        // { qX: ms }
        typing: {},        // { q6|q9|q12|q13: {keys,durationMs,cps} }
        last_rendered_at: Date.now(),
        outcome: null,     // 'complete'|'dq'|'quota'|'sec'
        outcome_reason: null
      };
      let S = loadState() || defaultState;

      // ===== QUESTIONS (v3) =====
      const Q = [
        { id:'consent', type:'consent', title:'Consent to Participate' },
        { id:'q2_age', type:'number', title:'What is your age?', min:18, max:99, dqOnInvalid:true },
        { id:'q3_gender', type:'single', title:'Gender', options:['Male','Female','Other'] },
        { id:'q4_zip', type:'zip5', title:'Enter your ZIP / Postal Code (5 digits)' },
        { id:'q5_laptop', type:'single', title:'Which laptop/computer do you use?', options:['Windows','Apple','Linux','Other','I don‚Äôt use a laptop'] },
        { id:'q6_weekend', type:'open', title:'In one sentence, describe your ideal weekend.', min:50, placeholder:'Type at least 50 characters', captureTyping:true },
        { id:'q7_shop', type:'single', title:'How often do you shop online?', options:['Daily','Weekly','Monthly','Rarely'] },
        { id:'q8_gate_banana', type:'single', title:'Quick mini-task: pick the fruit to earn 1 point üçå', options:['üöó Car','üçå Banana','üè† House'], correct:'üçå Banana', securityGate:true },
        { id:'q9_movie', type:'open', title:'Describe your favorite Hollywood movie and why it left an impact on you.', min:50, placeholder:'Min 50 characters', captureTyping:true },
        { id:'q10_employment', type:'single', title:'Employment status', options:['Full-time','Part-time','Self-employed','Student','Unemployed'], enforceAllowed:['Full-time','Part-time','Self-employed'] },
        { id:'q11_li_freq', type:'single', title:'How frequently do you use LinkedIn?', options:['I don‚Äôt use LinkedIn','Less than once a month','1‚Äì2 times a month','Weekly','1‚Äì2 hours daily'], dqOn:['I don‚Äôt use LinkedIn'] },
        { id:'q12_follow', type:'open', title:'Describe what type of groups, companies, or people you prefer to follow on LinkedIn:', min:100, placeholder:'Min 100 characters', captureTyping:true },
        { id:'q13_feature', type:'open', title:'According to you, what is the most useful feature in LinkedIn when looking for a job?', min:100, placeholder:'Min 100 characters', captureTyping:true },
        { id:'q14_gate_dog', type:'single', title:'Fun check: pick the animal that barks üê∂', options:['üê± Cat','üê∂ Dog','üê¢ Turtle'], correct:'üê∂ Dog', securityGate:true },
        { id:'q15_li_tenure', type:'single', title:'How long have you been using LinkedIn?', options:['Recently signed up','for almost a year','more than 2 years','I don‚Äôt use LinkedIn'], finalRouting:true }
      ];

      // ===== RENDERERS =====
      function render(){
        saveState();
        if(S.step === 'consent'){ renderConsent(); return; }
        if(S.step === 'q'){ renderQuestion(); return; }
        if(S.step === 'done'){ renderDone(); return; }
      }

      function renderConsent(){
        progressEl.textContent = 'Consent';
        nextBtn.textContent = 'I Agree and Continue';
        prevBtn.hidden = true;

        screenEl.innerHTML =
          '<h2 class="title">Consent to Participate</h2>' +
          '<p class="desc">Please confirm you consent to participate in this survey. Your responses will be used for research and may be anonymized. You can exit anytime.</p>' +
          '<div class="opt"><input id="consentChk" type="checkbox" aria-describedby="consentHint" />' +
          '<label for="consentChk">I agree to participate</label></div>' +
          '<p id="consentHint" class="hint">You must agree to proceed.</p>' +
          '<div class="actions" style="margin-top:10px">' +
          '  <button type="button" id="disagreeBtn" class="btn-secondary" aria-label="Decline and exit">I Disagree and Exit</button>' +
          '</div>' +
          '<p class="hint">Keyboard: press <span class="kbd">Enter</span> to continue.</p>';

        const chk = document.getElementById('consentChk');
        const dis = document.getElementById('disagreeBtn');
        if(chk) chk.focus();

        nextBtn.onclick = () => {
          if(!chk || !chk.checked){ showError('Please provide consent to continue.'); return; }
          S.step = 'q'; S.qIndex = 0; S.last_rendered_at = Date.now(); render();
        };
        if(dis){ dis.onclick = () => exitWithOutcome('dq','consent_declined'); }

        document.onkeydown = (e)=>{
          const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : "";
          if(e.key==='Enter' && tag !== 'textarea' && tag !== 'input'){ nextBtn.click(); }
        };
      }

      function renderQuestion(){
        const i = S.qIndex;
        const q = Q[i+1]; // +1 because index 0 is consent descriptor
        if(!q){ return completeFlow(); }
        updateProgress();
        prevBtn.hidden = true;
        nextBtn.textContent = (i+1) === (Q.length-1) ? 'Submit' : 'Next';

        let body = '<h2 class="title">'+escapeHTML(q.title)+'</h2>';
        let err  = '<div id="err" class="error" role="alert" aria-live="polite"></div>';

        if(q.type==='single'){
          body += '<div class="options" role="radiogroup" aria-label="options">';
          for(let idx=0; idx<q.options.length; idx++){
            const opt = q.options[idx];
            const id  = q.id + '_' + idx;
            const checked = (S.answers[q.id]===opt) ? 'checked' : '';
            body += '<div class="opt"><input '+checked+' type="radio" name="'+q.id+'" id="'+id+'" value="'+escapeHTML(opt)+'" aria-labelledby="'+id+'_lbl" />' +
                    '<label id="'+id+'_lbl" for="'+id+'">'+escapeHTML(opt)+'</label></div>';
          }
          body += '</div>';
        }

        if(q.type==='open'){
          const val = S.answers[q.id] || '';
          body += '<label for="'+q.id+'" class="sr-only">'+escapeHTML(q.title)+'</label>' +
                  '<textarea id="'+q.id+'" class="textarea" minlength="'+(q.min||0)+'" placeholder="'+escapeHTML(q.placeholder||'Type your answer‚Ä¶')+'" aria-describedby="'+q.id+'_hint">'+escapeHTML(val)+'</textarea>' +
                  '<p id="'+q.id+'_hint" class="hint">Minimum '+(q.min||0)+' characters.</p>';
        }

        if(q.type==='number'){
          const val = S.answers[q.id] || '';
          body += '<label for="'+q.id+'" class="sr-only">'+escapeHTML(q.title)+'</label>' +
                  '<input id="'+q.id+'" class="input" inputmode="numeric" pattern="[0-9]*" placeholder="Enter your age (18‚Äì99)" value="'+escapeHTML(String(val))+'" />';
        }

        if(q.type==='zip5'){
          const val = S.answers[q.id] || '';
          body += '<label for="'+q.id+'" class="sr-only">'+escapeHTML(q.title)+'</label>' +
                  '<input id="'+q.id+'" class="input" inputmode="numeric" pattern="\\d{5}" maxlength="5" placeholder="12345" value="'+escapeHTML(String(val))+'" />' +
                  '<p class="hint">Enter exactly 5 digits.</p>';
        }

        screenEl.innerHTML = body + err;

        // Per-question timing + typing cadence
        const qStart = Date.now();
        const typing = { keys:0, firstAt:null, lastAt:null };
        S.last_rendered_at = qStart;

        if(q.type==='open'){
          const ta = document.getElementById(q.id);
          if(ta){
            ta.addEventListener('keydown', () => {
              typing.keys++;
              const now = Date.now();
              if(!typing.firstAt) typing.firstAt = now;
              typing.lastAt = now;
            });
            ta.focus();
          }
        } else {
          const focusEl = screenEl.querySelector('input, textarea, input[type="radio"]');
          if(focusEl) focusEl.focus();
        }

        nextBtn.onclick = () => {
          const elapsed = Date.now() - qStart;

          if(q.type==='single'){
            const chosen = screenEl.querySelector('input[name="'+q.id+'"]:checked');
            if(!chosen){ return showError('Please select one option to continue.'); }
            const value = chosen.value;
            S.answers[q.id] = value;
            S.qTimes[q.id] = elapsed;

            if(q.dqOn && q.dqOn.includes(value)){
              return exitWithOutcome('dq', q.id+'_disqualifier');
            }
            if(q.securityGate && q.correct && value !== q.correct){
              return exitWithOutcome('sec', q.id+'_failed_gate');
            }
            if(q.enforceAllowed && !q.enforceAllowed.includes(value)){
              return exitWithOutcome('dq', q.id+'_disqualifier');
            }
            if(q.finalRouting){
              if(value === 'I don‚Äôt use LinkedIn'){
                return exitWithOutcome('dq','q15_li_tenure_disqualifier');
              } else {
                return exitWithOutcome('complete','q15_li_tenure_complete');
              }
            }
          }

          if(q.type==='open'){
            const ta = document.getElementById(q.id);
            const val = (ta && ta.value ? ta.value : '').trim();
            if((q.min||0) && val.length < q.min){
              if(ta){ ta.setAttribute('aria-invalid','true'); }
              return showError('Please enter at least '+(q.min||0)+' characters.');
            }
            S.answers[q.id] = val;
            S.qTimes[q.id] = elapsed;

            if(q.captureTyping && typing.firstAt && typing.lastAt){
              const duration = typing.lastAt - typing.firstAt;
              const cps = duration>0 ? +(typing.keys / (duration/1000)).toFixed(2) : 0;
              S.typing[q.id] = { keys: typing.keys, durationMs: duration, cps: cps };
            } else if(q.captureTyping){
              S.typing[q.id] = { keys: 0, durationMs: 0, cps: 0 };
            }
          }

          if(q.type==='number'){
            const input = document.getElementById(q.id);
            const val = input ? String(input.value).trim() : '';
            const num = Number(val);
            if(!val || !Number.isInteger(num) || num < (q.min||0) || num > (q.max||999)){
              return exitWithOutcome('dq','q2_age_invalid');
            }
            S.answers[q.id] = num;
            S.qTimes[q.id] = elapsed;
          }

          if(q.type==='zip5'){
            const input = document.getElementById(q.id);
            const val = input ? String(input.value).trim() : '';
            if(!/^\d{5}$/.test(val)){
              return showError('Please enter exactly 5 digits.');
            }
            S.answers[q.id] = val;
            S.qTimes[q.id] = elapsed;
          }

          S.qIndex = i+1;
          saveState();
          renderQuestion();
        };

        document.onkeydown = (e)=>{ 
          const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : "";
          if(e.key==='Enter' && tag !== 'textarea' && tag !== 'input'){ nextBtn.click(); } 
        };
      }

      function renderDone(){
        progressEl.textContent = 'Finished';
        nextBtn.hidden = true; prevBtn.hidden = true;
        screenEl.innerHTML = '<h2 class="title">You can close this tab.</h2>';
      }

      function updateProgress(){
        const totalQs = Q.length - 1;
        const curr = S.qIndex + 1;
        const shown = Math.min(curr, totalQs);
        progressEl.textContent = 'Q' + shown + ' of ' + totalQs;
      }

      function showError(msg){
        const el = document.getElementById('err'); if(el){ el.textContent = msg; }
      }

      // ===== OUTCOMES =====
      function completeFlow(){ exitWithOutcome('complete','natural_complete'); }

      function exitWithOutcome(type, reason){
        S.outcome = type; S.outcome_reason = reason; S.step = 'done';
        const endAt = Date.now();
        const payload = buildPayload(endAt);

        ENDPOINTS.forEach(url => sendPayload(url, payload));

        const status = (type==='complete') ? 1 : (type==='dq') ? 2 : (type==='quota') ? 3 : 4;
        const url = REDIRECT_BASE + '?status=' + status + '&transactionid=' + encodeURIComponent(PID);
        setTimeout(()=>{ location.href = url; }, 600);
        render();
      }

      function buildPayload(endAt){
        const total = Math.round((endAt - S.started_at)/1000);
        const device = {
          user_agent: navigator.userAgent,
          platform: navigator.platform,
          language: navigator.language,
          screen_w: window.screen.width,
          screen_h: window.screen.height,
          tz_offset_min: new Date().getTimezoneOffset()
        };
        return {
          x_key: NEUVEX_SHARED_KEY,
          version: S.version,
          pid: S.pid,
          outcome: S.outcome,
          reason: S.outcome_reason,
          started_at: new Date(S.started_at).toISOString(),
          ended_at: new Date(endAt).toISOString(),
          total_time_sec: total,
          answers: S.answers,
          q_times_ms: S.qTimes,
          typing_cadence: S.typing,
          last_index: S.qIndex,
          resumed: S.resumed,
          device
        };
      }

      function sendPayload(url, payload){
        try{
          const blob = new Blob([JSON.stringify(payload)],{type:'application/json'});
          if(navigator.sendBeacon){ navigator.sendBeacon(url, blob); }
          fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload), keepalive:true }).catch(()=>{});
          fetch(url, { method:'POST', mode:'no-cors', keepalive:true, body: JSON.stringify(payload) }).catch(()=>{});
        }catch(e){}
      }

      function saveState(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(S)); }catch(e){} }
      function loadState(){ try{ const raw = localStorage.getItem(STORAGE_KEY); if(!raw) return null; const obj = JSON.parse(raw); obj.resumed = true; return obj; }catch(e){ return null; } }

      // ===== INIT =====
      render();

    })();
  });

  function escapeHTML(s){
    var map = {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'};
    return (s||'').replace(/[&<>\"']/g, function(c){ return map[c]; });
  }
  </script>
</body>
</html>
